version: '3.9'
networks:
  network-hasher:
    internal: true
  network-redis:
    internal: true
  network-rng:
    internal: true
secrets:
  secret-hasher:
    file: ./hasher/hasher.rb
  secret-rng:
    file: ./rng/rng.py
  secret-webui:
    file: ./webui/webui.js
  secret-worker:
    file: ./worker/worker.py
services:
  svc-hasher:
    command: 
      - hasher.rb
    deploy:
      placement:
        constraints:
          - node.role == worker
    entrypoint:
      - ruby
    expose:
      - 8080/TCP
    image: jlbujeda/dockercoins-hasher:latest
    networks:
      - network-hasher
    secrets:
      - 
        mode: 0400
        source: secret-hasher
        target: /app/hasher.rb
        uid: '65534'
    user: nobody
    working_dir: /app/
  svc-redis:
    deploy:
      placement:
        constraints:
          - node.role == worker
    expose:
      - 6379/TCP
    image: redis:latest
    networks:
      - network-redis
    user: redis
    volumes:
      - 
        read_only: false
        source: volume-redis
        target: /data/
        type: volume
    working_dir: /data/
  svc-rng:
    command: 
      - rng.py
    deploy:
      placement:
        constraints:
          - node.role == worker
    entrypoint:
      - python
    expose:
      - 8080/TCP
    image: jlbujeda/dockercoins-rng:latest
    networks:
      - network-rng
    secrets:
      - 
        mode: 0400
        source: secret-rng
        target: /app/rng.py
        uid: '65534'
    user: nobody
    working_dir: /app/
  svc-webui:
    command: 
      - webui.js
    deploy:
      placement:
        constraints:
          - node.role == worker
    entrypoint:
      - node
    expose:
      - 8080/TCP
    image: jlbujeda/dockercoins-webui:latest
    networks:
      - network-redis
    ports:
      - 
        protocol: TCP
        published: 8080
        target: 8080
    secrets:
      - 
        mode: 0400
        source: secret-webui
        target: /app/webui.js
        uid: '65534'
    user: nobody
    working_dir: /app/
  svc-worker:
    command: 
      - worker.py
    deploy:
      placement:
        constraints:
          - node.role == worker
    entrypoint:
      - python
    image: jlbujeda/dockercoins-worker:latest
    networks:
      - network-hasher
      - network-redis
      - network-rng
    secrets:
      - 
        mode: 0400
        source: secret-worker
        target: /app/worker.py
        uid: '65534'
    user: nobody
    working_dir: /app/
volumes:
  volume-redis:
